openapi: 3.0.0

info:
  title: Operatto API
  description: |
    Operatto API - Sistema de pedidos multicanal.

  Modos de pedido:
  - WHATSAPP_INTERATIVO: pedido completo via WhatsApp
  - WEB_ONLY: WhatsApp envia apenas link para pedido Web
  version: 1.0.0

servers:
  - url: http://localhost:3000

tags:
  - name: Health
    description: Verificação de status da API
  - name: Produtos
    description: Cadastro e consulta de produtos
  - name: Pedidos
    description: Operações relacionadas a pedidos
  - name: Estoque
    description: Controle e movimentações de estoque

# =========================
# COMPONENTS (CONTRATOS)
# =========================
components:
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        details:
          type: array
          items:
            type: object
    OrderChannelMode:
      type: string
      enum:
        - WHATSAPP_INTERATIVO
        - WEB_ONLY
      example: WHATSAPP_INTERATIVO

    Produto:
  type: object
  required:
    - nome
    - unidade_medida
    - preco_venda
  properties:
    id:
      type: integer
      example: 1
    nome:
      type: string
      minLength: 3
      example: Bolacha Tradicional de Coco
    descricao:
      type: string
      example: Bolacha tradicional de coco
    unidade_medida:
      type: string
      example: UN
    preco_venda:
      type: number
      example: 3.50

  examples:
    ProdutosBasicos:
      value:
        - id: 1
          nome: Bolacha Tradicional de Coco
        - id: 2
          nome: Rosquinha de Coco
        - id: 3
          nome: Cacetinho de Coco
        - id: 4
          nome: Bolacha Amanteigada
        - id: 5
          nome: Bolacha Mimosa

    CriarPedido:
  type: object
  required:
    - clienteId
    - itens
  properties:
    clienteId:
      type: integer
      example: 1
    itens:
      type: array
      minItems: 1
      items:
        type: object
        required:
          - produtoId
          - quantidade
        properties:
          produtoId:
            type: integer
            example: 1
          quantidade:
            type: integer
            example: 20

    AtualizarStatusPedido:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum:
            - ABERTO
            - EM_PRODUCAO
            - FINALIZADO
            - CANCELADO

    EstoqueMovimentacao:
      type: object
      required:
        - id_produto
        - quantidade
        - origem
      properties:
        id_produto:
          type: integer
          example: 1
        quantidade:
          type: integer
          example: 10
        origem:
          type: string
          example: ENTRADA
        observacao:
          type: string
          example: Ajuste de estoque inicial

# =========================
# ROTAS
# =========================
paths:

  # -------- HEALTH --------
  /health:
    get:
      tags:
        - Health
      summary: Health check da API
      responses:
        "200":
          description: API funcionando
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  # -------- PRODUTOS --------
  /produtos:
    post:
      tags:
        - Produtos
      summary: Criar produto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Produto"
      responses:
        "201":
          description: Produto criado
        "400":
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      tags:
        - Produtos
      summary: Listar produtos
      responses:
        "200":
          description: Lista de produtos

  # -------- PEDIDOS --------
  /pedidos:
    post:
      tags:
        - Pedidos
      summary: Criar pedido
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CriarPedido"
      responses:
        "201":
          description: Pedido criado
        "400":
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /pedidos/{id}/status:
    patch:
      tags:
        - Pedidos
      summary: Atualizar status do pedido
      description: |
        Regras:
        - ABERTO → EM_PRODUCAO
        - EM_PRODUCAO → FINALIZADO
        - Qualquer status → CANCELADO
        - FINALIZADO não pode ser alterado
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            example: 6
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AtualizarStatusPedido"
      responses:
        "200":
          description: Status atualizado
        "400":
          description: Transição inválida
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Pedido não encontrado

  # -------- ESTOQUE --------
  /movimentacoes/entrada:
    post:
      tags:
        - Estoque
      summary: Entrada de estoque
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EstoqueMovimentacao"
      responses:
        "201":
          description: Entrada registrada
        "400":
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /movimentacoes/{idProduto}:
    get:
      tags:
        - Estoque
      summary: Listar movimentações por produto
      parameters:
        - name: idProduto
          in: path
          required: true
          schema:
            type: integer
            example: 1
      responses:
        "200":
          description: Lista de movimentações
        "404":
          description: Produto não encontrado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  # -------- CRIAR PEDIDO via Web --------
  /pedidos/web:
  post:
    tags:
      - Pedidos
    summary: Criar pedido via página web
    description: |
      Cria um pedido completo via Web.
      Usa o mesmo core de pedidos (FSM) do WhatsApp.
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required:
              - clienteId
              - itens
            properties:
              clienteId:
                type: integer
                example: 1
              itens:
                type: array
                minItems: 1
                items:
                  type: object
                  required:
                    - produtoId
                    - quantidade
                  properties:
                    produtoId:
                      type: integer
                      example: 1
                    quantidade:
                      type: integer
                      example: 20
    responses:
      "201":
        description: Pedido criado com sucesso
        content:
          application/json:
            schema:
              type: object
              properties:
                mensagem:
                  type: string
                  example: Pedido criado com sucesso
                pedido:
                  type: object
                  properties:
                    id:
                      type: integer
                      example: 123
                    clienteId:
                      type: integer
                      example: 1
                    itens:
                      type: array
                      items:
                        type: object
                        properties:
                          produtoId:
                            type: integer
                            example: 1
                          quantidade:
                            type: integer
                            example: 20
                    status:
                      type: string
                      example: CONFIRMADO
      "400":
        description: Payload inválido
      "409":
        description: Estoque insuficiente

